name: Train model
on: { workflow_dispatch: {} }

permissions:
  contents: read
  pull-requests: write

jobs:
  launch-runner:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: iterative/setup-cml@v2
      - name: Create Runner
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          REPO_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          AWS_REGION: us-east-1
          AWS_DEFAULT_REGION: us-east-1
        run: |
          cml runner launch --reuse \
            --labels=cml-runner \
            --cloud=aws \
            --cloud-region=us-east-1 \
            --cloud-image=iterative-cml \        # or use the id below
            # --cloud-image=ami-08b5a7c34b26aba4b \
            --cloud-type=m7i-flex.large \
            --cloud-hdd-size=40 \
            --idle-timeout=1200
            # If you lack a default VPC in us-east-1, uncomment and fill:
            # --cloud-vpc=vpc-xxxxxxxx \
            # --cloud-subnet=subnet-xxxxxxxx \
            # --cloud-security-group=sg-xxxxxxxx

  train-and-report:
    needs: launch-runner
    runs-on: [self-hosted, cml-runner]
    container:
      image: docker://iterativeai/cml:0-dvc2-base1
      options: --ipc=host --shm-size=2g
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"
      - name: Train model
        env:
          REPO_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          python --version
          pip install -r requirements.txt
          python train.py
          echo "## Report from your EC2 Instance" > report.md
          cat metrics.txt >> report.md
          echo '![](./confusion_matrix.png "Confusion Matrix")' >> report.md
          cml comment create report.md
